<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1, maximum-scale=1"
    />
    <style>
      .layui-form-item {
        margin: 20px 50px;
      }

      .layui-table-cell .layui-form-switch {
        display: block;
        width: 45px;
      }

      .layui-form-switch {
        margin-right: 5px;
      }

      .custom-switch {
        /* display: inline-flex; */
        display: block;
        align-items: center;
        cursor: pointer;
        user-select: none;
        color: #555;
        margin: auto;
      }

      .custom-switch .switch-track {
        width: 36px;
        height: 20px;
        background: #ddd;
        border-radius: 14px;
        padding: 2px;
        transition: background 0.3s ease;
        position: relative;
      }

      .custom-switch .switch-thumb {
        width: 16px;
        height: 16px;
        background: #fff;
        border-radius: 50%;
        transition: transform 0.3s ease;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
      }

      /* å¼€å¯çŠ¶æ€ */
      .custom-switch[data-status="on"] .switch-track {
        background: #16b777;
      }

      .custom-switch[data-status="on"] .switch-thumb {
        transform: translateX(8px);
      }

      .custom-switch[data-status="off"] .switch-thumb {
        transform: translateX(-7px);
      }
    </style>
  </head>

  <body>
    <div style="padding: 16px 16px 0 16px">
      <div class="layui-card">
        <div class="layui-card-body">
          <div style="display: flex; justify-content: space-between; align-items: center;">
            <div>
              <button
                class="layui-btn"
                id="ID_pull_onvif_btn"
                style="background-color: #16baaa"
                type="button"
              >
                ONVIFæ¥å…¥
              </button>
              <button
                class="layui-btn"
                id="ID_pull_url_btn"
                style="background-color: #16baaa"
                type="button"
              >
                ç›´æ’­æµæ¥å…¥
              </button>
            </div>
            <div>
              <button
                class="layui-btn"
                id="ID_pull_update_btn"
                style="background-color: #31bdec"
                type="button"
              >
                æ›´æ–°
              </button>
              <button
                class="layui-btn"
                id="ID_pull_export_btn"
                style="background-color: #5FB878"
                type="button"
              >
                å¯¼å‡º
              </button>
              <button
                class="layui-btn"
                id="ID_pull_import_btn"
                style="background-color: #FFB800"
                type="button"
              >
                å¯¼å…¥
              </button>
            </div>
          </div>
        </div>
    </div>

    <div style="padding: 16px">
      <div class="layui-card">
        <!-- <div class="layui-card-header">æµIDåˆ—è¡¨</div> -->
        <div class="layui-card-body">
          <div class="layui-form" style="padding-bottom: 16px">
            <div class="layui-inline">
              <div
                class="layui-input-inline"
                style="width: 200px; margin-right: 16px"
              >
                <input
                  type="text"
                  id="ID_searchApp"
                  placeholder="æœç´¢åº”ç”¨å"
                  class="layui-input"
                />
              </div>
              <div
                class="layui-input-inline"
                style="width: 200px; margin-right: 16px"
              >
                <input
                  type="text"
                  id="ID_searchStream"
                  placeholder="æœç´¢æµID"
                  class="layui-input"
                />
              </div>
              <button
                type="button"
                class="layui-btn layui-btn-sm"
                style="background-color: #16baaa; width: 54px"
                id="ID_table_btnSearch"
              >
                æœç´¢
              </button>
              <button
                type="button"
                class="layui-btn layui-btn-sm layui-btn-primary"
                style="width: 54px"
                id="ID_table_btnReset"
              >
                é‡ç½®
              </button>
            </div>
          </div>

          <table class="layui-hide" id="ID_streams_table"></table>
        </div>
      </div>
    </div>

    <!-- ç›´æ’­æµæ¥å…¥ æ¨¡æ¿ -->
    <script id="ID_tpl_pull_url" type="text/html">
      <form id="ID_active_pull_form" class="layui-form" action="">
        <!-- åŸºæœ¬é…ç½® -->
        <div class="layui-card" style="margin-bottom: 20px;">
          <div class="layui-card-header">
            <h3 style="margin: 0;">åŸºæœ¬é…ç½®</h3>
          </div>
          <div class="layui-card-body">
            <!-- è™šæ‹Ÿä¸»æœº -->
            <div class="layui-form-item">
              <label class="layui-form-label">è™šæ‹Ÿä¸»æœºå</label>
              <div class="layui-input-block">
                <input
                  type="text"
                  name="vhost"
                  value="__defaultVhost__"
                  required
                  placeholder="è™šæ‹Ÿä¸»æœºå"
                  autocomplete="off"
                  class="layui-input"
                />
              </div>
            </div>

            <!-- åº”ç”¨å -->
            <div class="layui-form-item">
              <label class="layui-form-label">åº”ç”¨å</label>
              <div class="layui-input-block">
                <input
                  type="text"
                  name="app"
                  value="live"
                  required
                  placeholder="è®¾ç½®ä¸€ä¸ªåº”ç”¨å"
                  autocomplete="off"
                  class="layui-input"
                />
              </div>
            </div>

            <!-- æµID -->
            <div class="layui-form-item">
              <label class="layui-form-label">æµID</label>
              <div class="layui-input-block">
                <input
                  type="text"
                  name="stream"
                  required
                  placeholder="ä¸ºè¯¥æµè®¾ç½®ä¸€ä¸ªæµID"
                  autocomplete="off"
                  class="layui-input"
                />
              </div>
            </div>

            <!-- æºæµåœ°å€ -->
            <div class="layui-form-item">
              <label class="layui-form-label">ç›´æ’­æµåœ°å€</label>
              <div class="layui-input-block">
                <input
                  type="text"
                  name="url"
                  required
                  placeholder="è¯·è¾“å…¥ç›´æ’­æµåœ°å€ï¼Œæ”¯æŒ RTSP / RTMP / FLV / HLS / TS ..."
                  autocomplete="off"
                  class="layui-input"
                />
              </div>
            </div>
          </div>
        </div>

        <!-- é«˜çº§é…ç½® -->
        <div class="layui-card">
          <div class="layui-card-header" style="cursor: pointer;" id="advanced_config_header">
            <h3 style="margin: 0; display: flex; justify-content: space-between; align-items: center;">
              <span>é«˜çº§é…ç½®</span>
              <i class="layui-icon layui-icon-down" id="advanced_config_icon"></i>
            </h3>
          </div>
          <div class="layui-card-body" id="advanced_config_body" style="display: none;">
            <!-- éŸ³é¢‘é…ç½® -->
            <div class="layui-form-item">
              <label class="layui-form-label">éŸ³é¢‘è®¾ç½®</label>
              <div class="layui-input-block">
                <input type="checkbox" name="enable_audio" title="å¯ç”¨éŸ³é¢‘" lay-skin="switch" />
                <input type="checkbox" name="add_mute_audio" title="æ·»åŠ é™éŸ³éŸ³é¢‘" lay-skin="switch" checked />
              </div>
            </div>

            <!-- ä¼ è¾“åè®® -->
            <div class="layui-form-item">
              <label class="layui-form-label">RTP ä¼ è¾“</label>
              <div class="layui-input-block">
                <select name="rtp_type">
                  <option value="0">RTP over RTSP (TCP)</option>
                  <option value="1">RTP over UDP</option>
                  <option value="2">Multicast</option>
                </select>
              </div>
            </div>

            <!-- æ‹‰æµé…ç½® -->
            <div class="layui-form-item">
              <label class="layui-form-label">æ‹‰æµé…ç½®</label>
              <div class="layui-input-block">
                <span style="margin-right: 10px;">æ‹‰æµè¶…æ—¶æ—¶é—´ï¼š</span>
                <input type="number" name="timeout_sec" value="15" placeholder="ç§’" class="layui-input" style="width: 150px; margin-right: 20px;" />
                <span style="margin-right: 10px;">é‡è¯•æ¬¡æ•°ï¼š</span>
                <input type="number" name="retry_count" value="-1" placeholder="-1æ— é™" class="layui-input" style="width: 150px;" />
              </div>
            </div>

            <!-- åˆ†å‘åè®® -->
            <div class="layui-form-item">
              <label class="layui-form-label">åˆ†å‘åè®®</label>
              <div class="layui-input-block">
                <input type="checkbox" name="enable_rtsp" title="RTSP" lay-skin="switch" />
                <input type="checkbox" name="enable_rtmp" title="RTMP" lay-skin="switch" checked />
                <input type="checkbox" name="enable_hls" title="HLS" lay-skin="switch" />
                <input type="checkbox" name="enable_ts" title="HTTP-TS" lay-skin="switch" />
                <input type="checkbox" name="enable_fmp4" title="HTTP-fMP4" lay-skin="switch" checked />
                <input type="checkbox" name="enable_hls_fmp4" title="HLS-fMP4" lay-skin="switch" />
              </div>
            </div>

            <!-- æŒ‰éœ€æ¨¡å¼ -->
            <div class="layui-form-item">
              <label class="layui-form-label">æŒ‰éœ€æ¨¡å¼</label>
              <div class="layui-input-block">
                <input type="checkbox" name="rtsp_demand" title="RTSP" lay-skin="switch" />
                <input type="checkbox" name="rtmp_demand" title="RTMP" lay-skin="switch" />
                <input type="checkbox" name="hls_demand" title="HLS" lay-skin="switch" />
                <input type="checkbox" name="ts_demand" title="HTTP-TS" lay-skin="switch" />
                <input type="checkbox" name="fmp4_demand" title="HTTP-fMP4" lay-skin="switch" />
              </div>
            </div>

            <!-- MP4å½•åˆ¶ -->
            <div class="layui-form-item">
              <label class="layui-form-label">MP4å½•åˆ¶</label>
              <div class="layui-input-block">
                <input type="checkbox" name="enable_mp4" title="å¯ç”¨MP4å½•åˆ¶" lay-skin="switch" />
                <input type="checkbox" name="mp4_as_player" title="å½“ä½œè§‚çœ‹è€…" lay-skin="switch" style="margin-left: 20px;" />
                <div style="margin-top: 10px; margin-left: 20px; display: inline-block;">
                  <span style="display: block; margin-bottom: 5px;">å½•åˆ¶åˆ‡ç‰‡å¤§å°ï¼š</span>
                  <input type="number" name="mp4_max_second" value="30" placeholder="ç§’" class="layui-input" style="width: 150px;" />
                </div>
              </div>
            </div>

            <!-- å…¶ä»–é…ç½® -->
            <div class="layui-form-item">
              <label class="layui-form-label">å…¶ä»–é…ç½®</label>
              <div class="layui-input-block">
                <select name="modify_stamp">
                  <option value="0">ç»å¯¹æ—¶é—´æˆ³</option>
                  <option value="1" selected>ç³»ç»Ÿæ—¶é—´æˆ³</option>
                  <option value="2">ç›¸å¯¹æ—¶é—´æˆ³</option>
                </select>
                <input type="checkbox" name="auto_close" title="æ— äººè§‚çœ‹è‡ªåŠ¨å…³é—­" lay-skin="switch" style="margin-left: 20px;" />
              </div>
            </div>
          </div>
        </div>

        <!-- æäº¤è¡¨å•æŒ‰é’® -->
        <div class="layui-form-item" style="margin-top: 20px; margin-bottom: 10px;">
          <div class="layui-input-block" style="text-align: center;">
            <button type="submit" class="layui-btn" id="btn_submit">
              æäº¤
            </button>
            <button
              type="button"
              class="layui-btn layui-btn-primary"
              id="btn_cancel"
              style="margin-left: 10px;"
            >
              å–æ¶ˆ
            </button>
          </div>
        </div>
      </form>
    </script>

    <!-- ONVIFæ¥å…¥ æ¨¡æ¿ -->
    <script id="ID_tpl_pull_onvif" type="text/html">
      <form id="ID_active_pull_form" class="layui-form" action="">
        <!-- æ‘„åƒæœºIP -->
        <div class="layui-form-item">
          <label class="layui-form-label">æ‘„åƒæœºåœ°å€</label>
          <div class="layui-input-inline">
            <input
              type="text"
              name="onvif-cameraip"
              required
              placeholder="è¯·è¾“å…¥ IP"
              autocomplete="off"
              class="layui-input"
            />
          </div>
          <div class="layui-form-mid">:</div>
          <div class="layui-input-inline" style="width: 120px;">
            <input
              type="number"
              name="onvif-port"
              value="80"
              min="1"
              max="65535"
              required
              placeholder="ç«¯å£"
              autocomplete="off"
              class="layui-input"
            />
          </div>
        </div>

        <!-- ç”¨æˆ·å -->
        <div class="layui-form-item">
          <label class="layui-form-label">ç”¨æˆ·å</label>
          <div class="layui-input-block">
            <input
              type="text"
              name="onvif-username"
              required
              placeholder="è¯·è¾“å…¥ç”¨æˆ·å"
              autocomplete="off"
              class="layui-input"
            />
          </div>
        </div>

        <!-- å¯†ç  -->
        <div class="layui-form-item">
          <label class="layui-form-label">ç™»å½•å¯†ç </label>
          <div class="layui-input-block">
            <input
              type="password"
              name="onvif-password"
              required
              placeholder="è¯·è¾“å…¥å¯†ç "
              autocomplete="off"
              class="layui-input"
            />
          </div>
        </div>

        <!-- è·å–è®¾å¤‡ä¿¡æ¯æŒ‰é’® -->
        <div class="layui-form-item">
          <div class="layui-input-block">
            <button
              type="button"
              class="layui-btn layui-btn-normal"
              id="btn_fetch_device"
            >
              è·å–è®¾å¤‡ä¿¡æ¯
            </button>
          </div>
        </div>

        <!-- è®¾å¤‡ä¿¡æ¯åŒºåŸŸ -->
        <div
          id="device_info_area"
          style="display:none; margin-top: 20px; padding: 15px; background: #f8f8f8; border-radius: 4px;"
        >
          <div class="layui-form-item" style="margin-top: 15px;">
            <label class="layui-form-label" style="padding-top: 0;"
              >è®¾å¤‡ä¿¡æ¯</label
            >
            <div class="layui-input-block">
              <p>
                <strong>å‚å•†ï¼š</strong><span id="device_manufacturer"></span>
              </p>
              <p><strong>å‹å·ï¼š</strong><span id="device_model"></span></p>
              <p>
                <strong>å›ºä»¶ç‰ˆæœ¬ï¼š</strong><span id="device_firmware"></span>
              </p>
              <p><strong>åºåˆ—å·ï¼š</strong><span id="device_serial"></span></p>
            </div>
          </div>

          <!-- é€‰æ‹©ç æµ -->
          <div class="layui-form-item" style="margin-top: 15px;">
            <label class="layui-form-label">é€‰æ‹©ç æµ</label>
            <div class="layui-input-block">
              <select
                name="selected_profile_token"
                lay-filter="profile_select"
                id="profile_select"
              ></select>
            </div>
          </div>
        </div>

        <!-- è™šæ‹Ÿä¸»æœº -->
        <input type="hidden" name="vhost" value="__defaultVhost__" />

        <!-- åº”ç”¨å -->
        <div class="layui-form-item" id="app_item" style="display:none;">
          <label class="layui-form-label">åº”ç”¨å</label>
          <div class="layui-input-block">
            <input
              type="text"
              name="app"
              value="live"
              required
              placeholder="è®¾ç½®ä¸€ä¸ªåº”ç”¨å"
              autocomplete="off"
              class="layui-input"
            />
          </div>
        </div>

        <!-- æµID -->
        <div class="layui-form-item" id="stream_item" style="display:none;">
          <label class="layui-form-label">æµID</label>
          <div class="layui-input-block">
            <input
              type="text"
              name="stream"
              required
              placeholder="ä¸ºè¯¥æµè®¾ç½®ä¸€ä¸ªæµID"
              autocomplete="off"
              class="layui-input"
            />
          </div>
        </div>

        <!-- éŸ³é¢‘è®¾ç½®ï¼ˆåˆå§‹ç¦ç”¨ï¼‰ -->
        <div class="layui-form-item" id="audio_item" style="display:none;">
          <label class="layui-form-label">éŸ³é¢‘è®¾ç½®</label>
          <div class="layui-input-block">
            <select name="audio_type">
              <option value="0">ä¸è½¬å‘éŸ³é¢‘</option>
              <option value="1">è½¬å‘åŸéŸ³é¢‘</option>
              <option value="2">è½¬å‘é™éŸ³éŸ³é¢‘</option>
            </select>
          </div>
        </div>

        <!-- æäº¤ä¸å–æ¶ˆ -->
        <div class="layui-form-item" id="submit_btns" style="display:none;">
          <div class="layui-input-block">
            <button type="submit" class="layui-btn" id="btn_submit">
              æäº¤
            </button>
            <button
              type="button"
              class="layui-btn layui-btn-primary"
              id="btn_cancel"
            >
              å–æ¶ˆ
            </button>
          </div>
        </div>
      </form>
    </script>

    <!-- toolbar æ¨¡æ¿ -->
    <script id="ID_tpl_toolbar" type="text/html">
      <div style="display: flex; gap: 5px;">
        <a
          class="layui-btn"
          lay-event="play"
          style="background-color: #16baaa; height: 26px;line-height: 26px; padding: 0 10px;"
          >é¢„è§ˆ</a
        >
        <a
          class="layui-btn"
          lay-event="edit"
          style="background-color: #31bdec; height: 26px;line-height: 26px; padding: 0 10px;"
          >ä¿®æ”¹</a
        >
        <a
          class="layui-btn"
          lay-event="del"
          style="background-color: #ff5722; height: 26px;line-height: 26px; padding: 0 10px;"
          >å…³é—­</a
        >
      </div>
    </script>

    <!-- player æ¨¡æ¿ -->
    <script id="ID_tpl_player" type="text/html">
      <div
        style="display: flex;justify-content: center;align-items: center; margin: 16px 16px 0 16px; flex-direction: column;"
      >
        <div style=" position: relative;">
          <video
            id="ID_player"
            autoplay
            style="width:960px; height:540px; background-color: #2f363c;"
          ></video>
          <div
            id="ID_status"
            style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); display: none; align-items: center; color: #eeeeee; font-weight: 500; font-size: 18px;"
          ></div>
        </div>
        <div id="ID_tabs" style="margin-top: 16px;"></div>
      </div>
    </script>

    <!-- record æ¨¡æ¿ -->
    <script id="ID_tpl_record" type="text/html">
      <form id="ID_record_form" class="layui-form" action="">
        <!-- å½•åƒ -->
        <div class="layui-form-item">
          <label class="layui-form-label">å½•åƒä¿ç•™(å¤©)</label>
          <div class="layui-input-block">
            <input
              type="number"
              name="record_days"
              value="1"
              autocomplete="off"
              class="layui-input"
              min="1"
              step="1"
              lay-affix="number"
            />
          </div>
        </div>
        <div class="layui-form-item">
          <div class="layui-input-block">
            <button type="submit" class="layui-btn" id="btn_submit">
              æäº¤
            </button>
            <button
              type="button"
              class="layui-btn layui-btn-primary"
              id="btn_cancel"
            >
              å–æ¶ˆ
            </button>
          </div>
        </div>
      </form>
    </script>

    <script>
      layui.use(["table", "layer", "form", "tabs", "jquery"], function () {
        let table = layui.table;
        let layer = layui.layer;
        let form = layui.form;
        let tabs = layui.tabs;
        let $ = layui.jquery;

        // æ¸²æŸ“è¡¨æ ¼
        function renderTable() {
          const app = $("#ID_searchApp").val().trim();
          const stream = $("#ID_searchStream").val().trim();

          // å…ˆè·å–æ‹‰æµä»£ç†åˆ—è¡¨ï¼ˆä¸»æ•°æ®ï¼‰
          $.ajax({
            url: "/api/stream/pull-proxy-list",
            type: "GET",
            dataType: "json",
            timeout: 10000,
            success: function (proxyRes) {
              if (proxyRes.code !== 0) {
                layer.msg("âŒ æ‹‰æµä»£ç†åˆ—è¡¨è·å–å¤±è´¥", {
                  time: 1500,
                  offset: "t",
                  shift: 1,
                });
                return;
              }

              let proxyList = proxyRes.data || [];

              // åº”ç”¨æœç´¢è¿‡æ»¤ï¼ˆæŒ‰ä»£ç†ä¸­çš„ app / streamï¼‰
              if (app) {
                proxyList = proxyList.filter((item) =>
                  item.src.app.includes(app)
                );
              }
              if (stream) {
                proxyList = proxyList.filter((item) =>
                  item.src.stream.includes(stream)
                );
              }

              // å†è·å–å½“å‰æ´»è·ƒæµåˆ—è¡¨
              $.ajax({
                url: "/api/stream/streamid-list",
                type: "GET",
                dataType: "json",
                timeout: 10000,
                success: function (streamRes) {
                  if (streamRes.code !== 0) {
                    layer.msg("âŒ æ´»è·ƒæµåˆ—è¡¨è·å–å¤±è´¥", {
                      time: 1500,
                      offset: "t",
                      shift: 1,
                    });
                    return;
                  }

                  // æ„å»ºæ´»è·ƒæµçš„ key é›†åˆï¼Œå¹¶ä¿å­˜ aliveSecond ç­‰ä¿¡æ¯
                  const activeStreamMap = {};
                  (streamRes.data || [])
                    .filter((item) => item.originTypeStr === "pull") // åªå…³å¿ƒ pull ç±»å‹
                    .forEach((item) => {
                      const key = `${item.vhost}/${item.app}/${item.stream}`;
                      activeStreamMap[key] = item; // å­˜æ•´ä¸ªå¯¹è±¡ï¼Œæ–¹ä¾¿å– aliveSecond ç­‰
                    });

                  // èåˆæ•°æ®ï¼šä»¥ proxyList ä¸ºä¸»
                  const tableData = proxyList.map((item) => {
                    const key = `${item.src.vhost}/${item.src.app}/${item.src.stream}`;
                    const activeInfo = activeStreamMap[key];

                    return {
                      vhost: item.src.vhost,
                      app: item.src.app,
                      stream: item.src.stream,
                      url: item.url,
                      rePullCount: item.rePullCount,

                      isOnline: !!activeInfo, // æ˜¯å¦åœ¨çº¿
                      totalReaderCount: activeInfo
                        ? activeInfo.totalReaderCount
                        : "-",
                      aliveSecond: activeInfo ? activeInfo.aliveSecond : "-",
                      isRecordingMP4: activeInfo
                        ? activeInfo.isRecordingMP4
                        : "-",
                      schemas: activeInfo ? activeInfo.schemas : "-",
                    };
                  });

                  // æ¸²æŸ“è¡¨æ ¼
                  table.render({
                    elem: "#ID_streams_table",
                    data: tableData,
                    cols: [
                      [
                        {
                          field: "id",
                          title: "åºå·",
                          align: "center",
                          width: 80,
                          templet: function (d) {
                            return d.LAY_NUM;
                          },
                        },
                        {
                          field: "app",
                          title: "åº”ç”¨å",
                          align: "center",
                          width: 120,
                        },
                        {
                          field: "stream",
                          title: "æµID",
                          align: "center",
                          width: 180,
                        },
                        {
                          field: "isOnline",
                          title: "åœ¨çº¿",
                          align: "center",
                          width: 120,
                          templet: function (d) {
                            let text = d.isOnline ? "âœ…" : "âŒ";
                            return `<span>${text}</span>`;
                          },
                        },
                        {
                          field: "url",
                          title: "æºæµåœ°å€",
                          align: "center",
                          minWidth: 300,
                          templet: function (d) {
                            return `<span>${d.url}</span>`;
                          },
                        },
                        {
                          field: "rePullCount",
                          title: "é‡è¿æ¬¡æ•°",
                          align: "center",
                          width: 120,
                        },
                        {
                          field: "aliveSecond",
                          title: "æ—¶é•¿",
                          align: "center",
                          width: 120,
                          templet: function (d) {
                            if (d.aliveSecond === "-") {
                              return "-";
                            }

                            let seconds = d.aliveSecond;
                            let h = Math.floor(seconds / 3600);
                            let m = Math.floor((seconds % 3600) / 60);
                            let s = seconds % 60;
                            return (
                              (h < 10 ? "0" + h : h) +
                              ":" +
                              (m < 10 ? "0" + m : m) +
                              ":" +
                              (s < 10 ? "0" + s : s)
                            );
                          },
                        },
                        {
                          field: "isRecordingMP4",
                          title: "å½•åˆ¶",
                          align: "center",
                          width: 120,
                          templet: function (d) {
                            if (d.isRecordingMP4 === "-") {
                              return "-";
                            }

                            let checked = d.isRecordingMP4 ? "checked" : "";

                            return `<div style="display: flex;justify-content: center;align-items: center; width: 100%; height: 100%;">
                                    <div class="custom-switch" lay-event="toggleRecord" data-vhost="${
                                      d.vhost
                                    }" data-app="${d.app}" data-stream="${
                              d.stream
                            }" data-status="${d.isRecordingMP4 ? "on" : "off"}">
                                      <div class="switch-track">
                                        <div class="switch-thumb"></div>
                                      </div>
                                    </div>
                                  </div>`;
                          },
                        },

                        {
                          field: "totalReaderCount",
                          title: "æ€»è§‚çœ‹äººæ•°",
                          align: "center",
                          width: 120,
                        },
                        {
                          field: "schemas",
                          title: "è½¬åè®®",
                          align: "center",
                          minWidth: 150,
                          templet: function (d) {
                            if (d.schemas === "-") {
                              return "-";
                            }

                            // åè®®æ˜ å°„é…ç½®ï¼ˆå¯å…¨å±€å®šä¹‰ä¸€æ¬¡ï¼‰
                            const schemaConfig = [
                              { key: "rtsp", name: "RTSP" },
                              { key: "rtmp", name: "RTMP" },
                              { key: "hls", name: "HLS" },
                              { key: "hls.fmp4", name: "HLS-fMP4" },
                              { key: "ts", name: "HTTP-TS" },
                              { key: "fmp4", name: "HTTP-fMP4" },
                              { key: "webrtc", name: "WebRTC" },
                              { key: "rtc", name: "RTC" },
                            ];

                            // æå– schemas ä¸­çš„ protocol
                            let enabledSchemas = Array.isArray(d.schemas)
                              ? d.schemas.map((item) => item.schema)
                              : [];

                            // å»é‡
                            let uniqueSchemas = [...new Set(enabledSchemas)];

                            if (uniqueSchemas.length === 0) {
                              return '<span class="layui-badge layui-bg-gray" style="font-size:14px;border-radius:5px;">æ— </span>';
                            }

                            // æ˜ å°„ä¸º badge
                            return uniqueSchemas
                              .map((schema) => {
                                let config = schemaConfig.find(
                                  (p) => p.key === schema
                                );
                                let displayName = config
                                  ? config.name
                                  : schema.toUpperCase();
                                return `<span class="layui-badge" style="margin-right: 4px; font-size: 14px; background-color: #31bdec; border-radius: 5px">${displayName}</span>`;
                              })
                              .join("");
                          },
                        },
                        {
                          field: "operate",
                          title: "æ“ä½œ",
                          width: 200,
                          align: "center",
                          fixed: "right",
                          toolbar: "#ID_tpl_toolbar",
                        },
                      ],
                    ],
                    page: true,
                    limits: [8, 16, 32],
                    limit: 8,
                  });
                },
                error: function () {
                  layer.msg("âŒ æ´»è·ƒæµåˆ—è¡¨è¯·æ±‚å¤±è´¥", {
                    time: 1500,
                    offset: "t",
                    shift: 1,
                  });
                },
              });
            },
            error: function () {
              layer.msg("âŒ æ‹‰æµä»£ç†åˆ—è¡¨è¯·æ±‚å¤±è´¥", {
                time: 1500,
                offset: "t",
                shift: 1,
              });
            },
          });
        }

        // ç›‘å¬è¡¨æ ¼æŒ‰é’®
        table.on("tool(ID_streams_table)", function (obj) {
          let data = obj.data; // å½“å‰è¡Œæ•°æ®
          let layEvent = obj.event; // è·å– lay-event çš„å€¼ï¼ˆdel, playï¼‰

          if (layEvent === "play") {
            let playerElement = null;
            let statusElement = null;

            layer.open({
              type: 1,
              title: "é¢„è§ˆ",
              area: ["1000px", "100%"],
              content: $("#ID_tpl_player").html(),
              btn: [],
              shadeClose: true,
              success: function () {
                playerElement = document.getElementById("ID_player");
                statusElement = document.getElementById("ID_status");

                let hasfMP4 = Array.isArray(data.schemas)
                  ? data.schemas.some((item) => item.schema === "fmp4")
                  : false;

                if (!hasfMP4) {
                  if (statusElement) {
                    statusElement.textContent = "è¯·åœ¨è®¾ç½®ä¸­å¼€å¯ HTTP-fMP4 åˆ†å‘";
                    statusElement.style.display = "flex";
                  }
                } else {
                  playerElement.src = `http://${window.location.hostname}:8080/${data.app}/${data.stream}.live.mp4`;
                  playerElement.load();

                  playerElement.play().catch((e) => {
                    console.error("æ’­æ”¾å¤±è´¥:", e);
                    if (statusElement) {
                      statusElement.textContent = "æ’­æ”¾å¤±è´¥ï¼Œè¯·æ£€æŸ¥æµæ˜¯å¦å­˜åœ¨";
                      statusElement.style.display = "flex";
                    }
                  });
                }

                let schemaConfig = {
                  rtsp: {
                    name: "RTSP",
                    port: 8554,
                    url: `rtsp://${window.location.hostname}:8554/${data.app}/${data.stream}`,
                  },
                  rtmp: {
                    name: "RTMP",
                    port: 1935,
                    url: `rtmp://${window.location.hostname}:1935/${data.app}/${data.stream}`,
                  },
                  hls: {
                    name: "HLS",
                    port: 8080,
                    url: `http://${window.location.hostname}:8080/${data.app}/${data.stream}/hls.m3u8`,
                  },
                  "hls.fmp4": {
                    name: "HLS-fMP4",
                    port: 8080,
                    url: `http://${window.location.hostname}:8080/${data.app}/${data.stream}/hls.fmp4.m3u8`,
                  },
                  ts: {
                    name: "HTTP-TS",
                    port: 8080,
                    url: `http://${window.location.hostname}:8080/${data.app}/${data.stream}.live.ts`,
                  },
                  fmp4: {
                    name: "HTTP-fMP4",
                    port: 8080,
                    url: `http://${window.location.hostname}:8080/${data.app}/${data.stream}.live.mp4`,
                  },
                };

                let headers = [];
                let bodies = [];

                (Array.isArray(data.schemas) ? data.schemas : [])
                  .filter((item) => item.schema) // ç¡®ä¿ schema å­˜åœ¨
                  .forEach((item) => {
                    let schema = item.schema;
                    let tracks = item.tracks || [];
                    let bytesSpeed = item.bytesSpeed || 0;
                    let readerCount = item.readerCount || 0;
                    let totalBytes = item.totalBytes || 0;

                    // æ ¼å¼åŒ–æµé‡å•ä½ï¼ˆB, KB, MB, GBï¼‰
                    function formatBytes(bytes) {
                      if (bytes === 0) return "0 B";
                      const k = 1024;
                      const sizes = ["B", "KB", "MB", "GB"];
                      const i = Math.floor(Math.log(bytes) / Math.log(k));
                      return (
                        parseFloat((bytes / Math.pow(k, i)).toFixed(2)) +
                        " " +
                        sizes[i]
                      );
                    }

                    // æ„å»ºè½¨é“ä¿¡æ¯ HTML
                    let trackHtml = `<div style='line-height: 1.8;'>è½¨é“ä¿¡æ¯ï¼š<br>`;
                    if (tracks.length === 0) {
                      trackHtml += `<span>æ— è½¨é“ä¿¡æ¯</span><br>`;
                    } else {
                      tracks.forEach((track) => {
                        let type =
                          track.codec_type === 0
                            ? "Video"
                            : track.codec_type === 1
                            ? "Audio"
                            : "Other";

                        let detail = "";
                        if (track.codec_type === 0) {
                          // è§†é¢‘
                          detail = `ç¼–ç  ${track.codec_id_name}ï¼Œåˆ†è¾¨ç‡ ${
                            track.width
                          }x${track.height}@${track.fps || "?"}FPSï¼ŒGOP ${
                            track.gop_size
                          } (${track.gop_interval_ms}ms)`;
                        } else if (track.codec_type === 1) {
                          // éŸ³é¢‘
                          detail = `ç¼–ç  ${track.codec_id_name}ï¼Œ${track.sample_rate}Hzï¼Œ${track.channels}å£°é“`;
                        } else {
                          detail = `ç¼–ç  ${track.codec_id_name || "Unknown"}`;
                        }
                        trackHtml += `<span>ã€${type}ã€‘${detail}</span><br>`;
                      });
                    }
                    trackHtml += "</div>";

                    // æ„å»ºè½¬å‘åœ°å€ä¸ç»Ÿè®¡ä¿¡æ¯
                    let config = schemaConfig[schema] || {
                      name: schema.toUpperCase(),
                      url: "#",
                    };
                    let protocolName = config.name;
                    let forwardUrl = config.url;

                    // ç»Ÿè®¡ä¿¡æ¯
                    let statsHtml = `
                                    <div style="margin-top: 8px; padding: 8px; background: #f8f9fa; border-radius: 4px; font-size: 13px;">
                                      ğŸŒ å½“å‰ç ç‡: ${(
                                        (bytesSpeed * 8) /
                                        1048576
                                      ).toFixed(2)} Mbpsï¼Œ
                                      ğŸ‘¤ å½“å‰åœ¨çº¿: ${readerCount} äººï¼Œ
                                      ğŸ“¦ æ€»æµé‡: ${formatBytes(totalBytes)}
                                    </div>`;

                    let copyCode = `copyToClipboard('${forwardUrl}')`;

                    let html = `
                                <div style="font-size: 14px; color: #333;">

                                  ${trackHtml}
                                  ${statsHtml}

                                  <div style="margin-top: 10px;">
                                    è½¬å‘åœ°å€ï¼ˆç‚¹å‡»å¤åˆ¶ï¼‰ï¼š<br>
                                    <span
                                      onclick="${copyCode}"
                                      title="ç‚¹å‡»å¤åˆ¶"
                                      style="
                                        display: inline-block;
                                        margin-top: 4px;
                                        padding: 6px 10px;
                                        background: #f0f0f0;
                                        border: 1px solid #ddd;
                                        border-radius: 4px;
                                        cursor: pointer;
                                        font-family: monospace;
                                        font-size: 13px;
                                        word-break: break-all;
                                      "
                                    >
                                      ${forwardUrl}
                                    </span>
                                  </div>
                                </div>`;

                    headers.push({ title: protocolName });
                    bodies.push({ content: html });
                  });

                // å¦‚æœæ²¡æœ‰ä»»ä½•åè®®è¢«å¯ç”¨
                if (bodies.length === 0) {
                  headers.push({ title: "æ— å¯ç”¨åè®®" });
                  bodies.push({
                    content: `<div style="color: #999; text-align: center; padding: 20px;">å½“å‰æµæœªå¼€å¯ä»»ä½•åè®®è½¬å‘</div>`,
                  });
                }

                // æ¸²æŸ“ Tabs
                tabs.render({
                  elem: "#ID_tabs",
                  header: headers,
                  body: bodies,
                });
              },

              end: function () {
                if (playerElement) {
                  playerElement.pause();
                  playerElement.src = ""; // å…ˆæ¸…ç©ºï¼Œä¸­æ–­æ—§è¿æ¥
                  playerElement.load();
                }
              },
            });
          } else if (layEvent === "del") {
            // å…³é—­ç¡®è®¤
            layer.confirm(
              `ç¡®å®šè¦å…³é—­<span style = "margin-bottom: 6px; padding: 4px; background: #f7f7f7; border-radius: 4px;">${data.app} / ${data.stream}</span>å—?`,
              {
                title: "æç¤º",
              },
              function (index) {
                // æ‰§è¡Œå…³é—­è¯·æ±‚
                $.ajax({
                  url: `/api/stream/pull-proxy?vhost=${data.vhost}&app=${data.app}&stream=${data.stream}`,
                  type: "DELETE",
                  success: function (res) {
                    console.log(res);

                    if (res.code === 0) {
                      layer.msg("âœ… å…³é—­æˆåŠŸ", {
                        time: 1500,
                        offset: "t",
                        shift: 1,
                      });
                      renderTable();
                    }
                  },
                });

                layer.close(index); // å…³é—­å¼¹çª—
              }
            );
          } else if (layEvent === "toggleRecord") {
            let vhost = data.vhost;
            let app = data.app;
            let stream = data.stream;
            let isRecord = data.isRecordingMP4;

            if (isRecord) {
              layer.confirm(
                `ç¡®å®šè¦åœæ­¢<span style = "margin-bottom: 6px; padding: 4px; background: #f7f7f7; border-radius: 4px;">${app} / ${stream}</span>å½•åƒå—?`,
                {
                  title: "æç¤º",
                },
                function (index) {
                  $.ajax({
                    url: `/api/playback/stop-record?vhost=${vhost}&app=${app}&stream=${stream}`,
                    type: "GET",
                    success: function (res) {
                      if (res.code === 0) {
                        layer.msg("âœ… å…³é—­æˆåŠŸ", {
                          time: 1500,
                          offset: "t",
                          shift: 1,
                        });
                        renderTable();
                      } else {
                        layer.msg("âš ï¸ " + res.msg, {
                          time: 1500,
                          offset: "t",
                          shift: 1,
                        });
                      }
                    },
                  });
                  layer.close(index); // å…³é—­å¼¹çª—
                }
              );
            } else {
              layer.open({
                type: 1,
                title: "å¼€å¯å½•åƒ",
                area: ["500px", "auto"],
                content: $("#ID_tpl_record").html(),
                btn: null,
                shadeClose: true,
                success: function (layero, index) {
                  form.render();

                  layero.find("#btn_submit").on("click", function (e) {
                    e.preventDefault(); // é˜»æ­¢é»˜è®¤æäº¤ï¼ˆé˜²æ­¢é¡µé¢åˆ·æ–°ï¼‰

                    let $form = layero.find("#ID_record_form");

                    let formData = {};
                    $form.find("input, select").each(function () {
                      let $el = $(this);
                      let name = $el.attr("name");
                      if (!name) return true; // elem æ²¡æœ‰ name å°±è·³è¿‡

                      let value;
                      if ($el.is(":checkbox")) {
                        // å¤„ç† checkboxï¼šchecked æ—¶å– valueï¼Œå¦åˆ™ä¸º 'false'
                        value = $el.is(":checked") ? "true" : "false";
                      } else {
                        value = $el.val();
                      }

                      formData[name] = value;
                    });

                    if (
                      !/^\d+$/.test(formData["record_days"]) ||
                      parseInt(formData["record_days"], 10) < 0 ||
                      parseInt(formData["record_days"], 10) > 30
                    ) {
                      layer.msg("âš ï¸ å½•åƒå¤©æ•°å»ºè®®ä¸è¦è¶…è¿‡30å¤©", {
                        time: 1500,
                        offset: "t",
                        shift: 1,
                      });
                      return false;
                    }
                    // å‘é€è¯·æ±‚
                    $.ajax({
                      url: `/api/playback/start-record?vhost=${vhost}&app=${app}&stream=${stream}&record_days=${formData["record_days"]}`,
                      type: "GET",
                      timeout: 5000,
                      success: function (res) {
                        if (res.code === 0) {
                          layer.msg("âœ… å¼€å§‹å½•åƒ", {
                            time: 1500,
                            offset: "t",
                            shift: 1,
                          });
                          setTimeout(() => {
                            layer.close(index);
                          }, 400);
                        } else {
                          layer.msg("âš ï¸ " + res.msg, {
                            time: 1500,
                            offset: "t",
                            shift: 1,
                          });
                        }
                        renderTable();
                      },
                    });
                  });

                  layero.find("#btn_cancel").on("click", function () {
                    layer.close(index);
                  });
                },
                end: function () {
                  // ç›‘å¬å¼¹çª—å…³é—­å°±åˆ·æ–°è¡¨æ ¼
                  renderTable();
                },
              });
            }
          } else if (layEvent === "edit") {
            // ä¿®æ”¹æ‹‰æµé…ç½®
            // å…ˆä»æ•°æ®åº“è·å–è¯¦ç»†é…ç½®
            $.ajax({
              url: "/api/stream/pull-proxy-list-db",
              type: "GET",
              dataType: "json",
              success: function (res) {
                if (res.code === 0) {
                  let streamConfig = res.data.find(
                    item => item.app === data.app && item.stream === data.stream
                  );
                  
                  if (streamConfig) {
                    // æ‰“å°streamConfigå¯¹è±¡ï¼Œç”¨äºè°ƒè¯•
                    console.log('streamConfig:', streamConfig);
                    // æ‰“å¼€ä¿®æ”¹çª—å£
                    layer.open({
                      type: 1,
                      title: "ä¿®æ”¹æ‹‰æµé…ç½®",
                      area: ["700px", "400px"],
                      content: $("#ID_tpl_pull_url").html(),
                      shadeClose: true,
                      btn: null,
                      success: function (layero, index) {
                        // å¡«å……è¡¨å•æ•°æ®
                        let $form = layero.find("#ID_active_pull_form");
                        // è®¾ç½®åŸºæœ¬é…ç½®å‚æ•°ä¸ºåªè¯»
                        $form.find("[name='vhost']").val(streamConfig.vhost).attr("readonly", "readonly");
                        $form.find("[name='app']").val(streamConfig.app).attr("readonly", "readonly");
                        $form.find("[name='stream']").val(streamConfig.stream).attr("readonly", "readonly");
                        $form.find("[name='url']").val(streamConfig.url).attr("readonly", "readonly");
                        
                        // å¡«å……é«˜çº§é…ç½®å‚æ•°
                        // éŸ³é¢‘è®¾ç½®
                        $form.find("[name='enable_audio']").prop("checked", streamConfig.enable_audio === 1);
                        $form.find("[name='add_mute_audio']").prop("checked", streamConfig.add_mute_audio === 1);
                        
                        // RTPä¼ è¾“
                        if (streamConfig.rtp_type !== undefined) {
                          $form.find("[name='rtp_type']").val(streamConfig.rtp_type);
                        }
                        
                        // æ‹‰æµé…ç½®
                        $form.find("[name='timeout_sec']").val(streamConfig.timeout_sec || 15);
                        $form.find("[name='retry_count']").val(streamConfig.retry_count || -1);
                        
                        // åˆ†å‘åè®®
                        $form.find("[name='enable_rtsp']").prop("checked", streamConfig.enable_rtsp === 1);
                        $form.find("[name='enable_rtmp']").prop("checked", streamConfig.enable_rtmp === 1);
                        $form.find("[name='enable_hls']").prop("checked", streamConfig.enable_hls === 1);
                        $form.find("[name='enable_ts']").prop("checked", streamConfig.enable_ts === 1);
                        $form.find("[name='enable_fmp4']").prop("checked", streamConfig.enable_fmp4 === 1);
                        $form.find("[name='enable_hls_fmp4']").prop("checked", streamConfig.enable_hls_fmp4 === 1);
                        
                        // æŒ‰éœ€æ¨¡å¼
                        $form.find("[name='rtsp_demand']").prop("checked", streamConfig.rtsp_demand === 1);
                        $form.find("[name='rtmp_demand']").prop("checked", streamConfig.rtmp_demand === 1);
                        $form.find("[name='hls_demand']").prop("checked", streamConfig.hls_demand === 1);
                        $form.find("[name='ts_demand']").prop("checked", streamConfig.ts_demand === 1);
                        $form.find("[name='fmp4_demand']").prop("checked", streamConfig.fmp4_demand === 1);
                        
                        // MP4å½•åˆ¶
                        $form.find("[name='enable_mp4']").prop("checked", streamConfig.enable_mp4 === 1);
                        $form.find("[name='mp4_as_player']").prop("checked", streamConfig.mp4_as_player === 1);
                        $form.find("[name='mp4_max_second']").val(streamConfig.mp4_max_second || 30);
                        
                        // å…¶ä»–é…ç½®
                        if (streamConfig.modify_stamp !== undefined) {
                          $form.find("[name='modify_stamp']").val(streamConfig.modify_stamp);
                        }
                        $form.find("[name='auto_close']").prop("checked", streamConfig.auto_close === 1);
                        
                        // æ¸²æŸ“ layui è¡¨å•æ§ä»¶
                        form.render();

                        // é«˜çº§é…ç½®é»˜è®¤å±•å¼€ï¼Œä¸”ä¸å¯ä»¥æŠ˜å 
                        let body = layero.find("#advanced_config_body");
                        let icon = layero.find("#advanced_config_icon");
                        let header = layero.find("#advanced_config_header");
                        body.show();
                        icon.removeClass("layui-icon-down").addClass("layui-icon-up");
                        // ç§»é™¤ç‚¹å‡»äº‹ä»¶ï¼Œä½¿é«˜çº§é…ç½®ä¸å¯ä»¥æŠ˜å 
                        header.off("click");
                        // ä¿®æ”¹æ ·å¼ï¼Œä½¿å…¶çœ‹èµ·æ¥ä¸å¯ç‚¹å‡»
                        header.css({"cursor": "default", "pointer-events": "none"});

                        // è¡¨å•æäº¤
                        layero.find("#btn_submit").on("click", function (e) {
                          e.preventDefault(); // é˜»æ­¢é»˜è®¤æäº¤ï¼ˆé˜²æ­¢é¡µé¢åˆ·æ–°ï¼‰

                          // è·å–è¡¨å•
                          let $form = layero.find("#ID_active_pull_form");

                          // å¿…å¡«é¡¹éªŒè¯
                          let isValid = true;
                          $form.find("input[required]").each(function () {
                            let val = $(this).val();
                            if (!val || val.trim() === "") {
                              let placeholder = $(this).attr("placeholder") || "è¯¥å­—æ®µ";

                              layer.msg("âš ï¸ è¯·å¡«å†™ï¼š" + placeholder, {
                                time: 1500,
                                offset: "t",
                                shift: 1,
                              });

                              $(this).focus();
                              isValid = false;
                              return false; // è·³å‡º each å¾ªç¯
                            }
                          });
                          if (!isValid) return false;

                          let formData = {};
                          $form.find("input, select").each(function () {
                            let $el = $(this);
                            let name = $el.attr("name");
                            if (!name) return true;

                            let value;
                            if ($el.is(":checkbox")) {
                              value = $el.is(":checked") ? "1" : "0";
                            } else {
                              value = $el.val();
                            }

                            formData[name] = value;
                          });

                          // æ„å»ºè¯·æ±‚URLï¼ŒåŒ…å«æ‰€æœ‰å‚æ•°
                          let urlParams = new URLSearchParams();
                          for (let key in formData) {
                            urlParams.append(key, formData[key]);
                          }

                          $.ajax({
                            url: `/api/stream/pull-proxy?${urlParams.toString()}`,
                            type: "POST",
                            timeout: 5000,
                            success: function (res) {
                              if (res.code === 0) {
                                layer.msg("âœ… ä¿®æ”¹æˆåŠŸ", {
                                  time: 1500,
                                  offset: "t",
                                  shift: 1,
                                });
                                setTimeout(() => {
                                  layer.close(index);
                                }, 300);
                              } else {
                                layer.msg("âš ï¸ " + res.msg, {
                                  time: 1500,
                                  offset: "t",
                                  shift: 1,
                                });
                              }
                            },
                          });
                        });

                        // ç»‘å®šå–æ¶ˆæŒ‰é’®äº‹ä»¶
                        layero.find("#btn_cancel").on("click", function () {
                          layer.close(index);
                        });
                      },
                      end: function () {
                        // ç›‘å¬å¼¹çª—å…³é—­å°±åˆ·æ–°è¡¨æ ¼
                        setTimeout(() => {
                          renderTable();
                        }, 300);
                      },
                    });
                  } else {
                    layer.msg("âš ï¸ æœªæ‰¾åˆ°è¯¥æµçš„è¯¦ç»†é…ç½®", {
                      time: 1500,
                      offset: "t",
                      shift: 1,
                    });
                  }
                }
              },
              error: function () {
                layer.msg("âŒ è·å–é…ç½®å¤±è´¥", {
                  time: 1500,
                  offset: "t",
                  shift: 1,
                });
              }
            });
          }
        });

        // ç›‘å¬æ›´æ–°æŒ‰é’®
        $("#ID_pull_update_btn").on("click", function () {
          layer.confirm(
            "æ­¤æ“ä½œä¼šæŠŠæ•°æ®åº“ä¸­çš„æ‹‰æµä¿¡æ¯æ•´ä½“æ›´æ–°ç»™ZLMediaKitæœåŠ¡å™¨ï¼Œç¡®å®šç»§ç»­å—ï¼Ÿ",
            {
              title: "æç¤º",
              btn: ["ç¡®å®š", "å–æ¶ˆ"]
            },
            function (index) {
              layer.close(index);
              
              // æ˜¾ç¤ºåŠ è½½åŠ¨ç”»
              let loading = layer.load(2, { shade: [0.1, "#fff"] });
              
              // å‘é€æ›´æ–°è¯·æ±‚
              $.ajax({
                url: "/api/stream/pull-proxy-load",
                type: "POST",
                dataType: "json",
                success: function (res) {
                  layer.close(loading);
                  if (res.code === 0) {
                    layer.msg("âœ… æ›´æ–°æˆåŠŸ" + res.msg, {
                      time: 2000,
                      offset: "t",
                      shift: 1,
                    });
                    // åˆ·æ–°è¡¨æ ¼
                    setTimeout(() => {
                      renderTable();
                    }, 500);
                  } else {
                    layer.msg("âŒ æ›´æ–°å¤±è´¥ï¼š" + res.msg, {
                      time: 1500,
                      offset: "t",
                      shift: 1,
                    });
                  }
                },
                error: function () {
                  layer.close(loading);
                  layer.msg("âŒ ç½‘ç»œè¯·æ±‚å¤±è´¥", {
                    time: 1500,
                    offset: "t",
                    shift: 1,
                  });
                }
              });
            }
          );
        });

        // ç›‘å¬å¯¼å‡ºæŒ‰é’®
        $("#ID_pull_export_btn").on("click", function () {
          $.ajax({
            url: "/api/stream/pull-proxy-export",
            type: "GET",
            dataType: "json",
            success: function (res) {
              if (res.code === 0) {
                // åˆ›å»ºä¸‹è½½é“¾æ¥
                let blob = new Blob([res.data], { type: "text/csv;charset=utf-8;" });
                let url = URL.createObjectURL(blob);
                let link = document.createElement("a");
                link.setAttribute("href", url);
                link.setAttribute("download", `pull-streams-${new Date().getTime()}.csv`);
                link.style.visibility = "hidden";
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                layer.msg("âœ… å¯¼å‡ºæˆåŠŸ", {
                  time: 1500,
                  offset: "t",
                  shift: 1,
                });
              } else {
                layer.msg("âŒ å¯¼å‡ºå¤±è´¥ï¼š" + res.msg, {
                  time: 1500,
                  offset: "t",
                  shift: 1,
                });
              }
            },
            error: function () {
              layer.msg("âŒ ç½‘ç»œè¯·æ±‚å¤±è´¥", {
                time: 1500,
                offset: "t",
                shift: 1,
              });
            }
          });
        });

        // ç›‘å¬å¯¼å…¥æŒ‰é’®
        $("#ID_pull_import_btn").on("click", function () {
          // åˆ›å»ºå¯¼å…¥çª—å£
          layer.open({
            type: 1,
            title: "å¯¼å…¥æ‹‰æµé…ç½®",
            area: ["600px", "auto"],
            content: `
              <div style="padding: 20px;">
                <p style="margin-bottom: 20px;">è¯·é€‰æ‹©è¦å¯¼å…¥çš„CSVæ–‡ä»¶ï¼Œå¯¼å…¥åä¼šè¦†ç›–ç°æœ‰é…ç½®</p>
                <input type="file" id="import_file" accept=".csv" style="margin-bottom: 20px;">
                <div style="color: #999; font-size: 12px;">
                  æç¤ºï¼šå¯¼å…¥çš„CSVæ–‡ä»¶å¿…é¡»åŒ…å«appã€streamã€urlç­‰å¿…è¦å­—æ®µ
                </div>
              </div>
            `,
            btn: ["ç¡®å®šå¯¼å…¥", "å–æ¶ˆ"],
            btn1: function (index) {
              let fileInput = document.getElementById("import_file");
              let file = fileInput.files[0];
              
              if (!file) {
                layer.msg("âš ï¸ è¯·é€‰æ‹©CSVæ–‡ä»¶", {
                  time: 1500,
                  offset: "t",
                  shift: 1,
                });
                return false;
              }
              
              // è¯»å–æ–‡ä»¶å†…å®¹
              let reader = new FileReader();
              reader.onload = function (e) {
                let csvContent = e.target.result;
                
                // æ˜¾ç¤ºç¡®è®¤å¯¹è¯æ¡†
                layer.confirm(
                  "æ­¤æ“ä½œä¼šæŠŠæ–‡ä»¶ä¸­çš„é…ç½®æ•´ä½“æ›´æ–°ç»™ZLMediaKitæœåŠ¡å™¨ï¼Œç¡®å®šç»§ç»­å—ï¼Ÿ",
                  {
                    title: "æç¤º",
                    btn: ["ç¡®å®š", "å–æ¶ˆ"]
                  },
                  function (confirmIndex) {
                    layer.close(confirmIndex);
                    
                    // æ˜¾ç¤ºåŠ è½½åŠ¨ç”»
                    let loading = layer.load(2, { shade: [0.1, "#fff"] });
                    
                    // å‘é€å¯¼å…¥è¯·æ±‚
                    $.ajax({
                      url: "/api/stream/pull-proxy-import",
                      type: "POST",
                      contentType: "application/json",
                      data: JSON.stringify({ csv_content: csvContent }),
                      dataType: "json",
                      success: function (res) {
                        layer.close(loading);
                        if (res.code === 0) {
                          layer.msg("âœ… å¯¼å…¥æˆåŠŸ" + res.msg, {
                            time: 2000,
                            offset: "t",
                            shift: 1,
                          });
                          // åˆ·æ–°è¡¨æ ¼
                          setTimeout(() => {
                            renderTable();
                          }, 500);
                        } else {
                          layer.msg("âŒ å¯¼å…¥å¤±è´¥ï¼š" + res.msg, {
                            time: 1500,
                            offset: "t",
                            shift: 1,
                          });
                        }
                      },
                      error: function () {
                        layer.close(loading);
                        layer.msg("âŒ ç½‘ç»œè¯·æ±‚å¤±è´¥", {
                          time: 1500,
                          offset: "t",
                          shift: 1,
                        });
                      }
                    });
                  }
                );
              };
              reader.readAsText(file);
              
              layer.close(index);
            }
          });
        });

        // ç›‘å¬ç›´æ’­æµæ¥å…¥æŒ‰é’®
        $("#ID_pull_url_btn").on("click", function () {
          // å…ˆè·å–é»˜è®¤é…ç½®
          $.ajax({
            url: "/api/stream/default-configs",
            type: "GET",
            dataType: "json",
            success: function (res) {
              if (res.code === 0) {
                let defaultConfigs = res.data;
                
                layer.open({
                  type: 1,
                  title: "ç›´æ’­æµæ¥å…¥",
                  area: ["800px", "700px"],
                  content: $("#ID_tpl_pull_url").html(),
                  shadeClose: true,
                  btn: null,
                  success: function (layero, index) {
                    let $form = layero.find("#ID_active_pull_form");
                    
                    // å¡«å……é»˜è®¤é…ç½®å‚æ•°
                    // åŸºæœ¬é…ç½®
                    $form.find("[name='vhost']").val(defaultConfigs.vhost || "__defaultVhost__");
                    $form.find("[name='app']").val(defaultConfigs.app || "live");
                    
                    // é«˜çº§é…ç½®
                    // éŸ³é¢‘è®¾ç½®
                    $form.find("[name='enable_audio']").prop("checked", defaultConfigs.enable_audio === "1");
                    $form.find("[name='add_mute_audio']").prop("checked", defaultConfigs.add_mute_audio === "1");
                    
                    // RTPä¼ è¾“
                    if (defaultConfigs.rtp_type !== undefined) {
                      $form.find("[name='rtp_type']").val(defaultConfigs.rtp_type);
                    }
                    
                    // æ‹‰æµé…ç½®
                    $form.find("[name='timeout_sec']").val(defaultConfigs.timeout_sec || 15);
                    $form.find("[name='retry_count']").val(defaultConfigs.retry_count || -1);
                    
                    // åˆ†å‘åè®®
                    $form.find("[name='enable_rtsp']").prop("checked", defaultConfigs.enable_rtsp === "1");
                    $form.find("[name='enable_rtmp']").prop("checked", defaultConfigs.enable_rtmp === "1");
                    $form.find("[name='enable_hls']").prop("checked", defaultConfigs.enable_hls === "1");
                    $form.find("[name='enable_ts']").prop("checked", defaultConfigs.enable_ts === "1");
                    $form.find("[name='enable_fmp4']").prop("checked", defaultConfigs.enable_fmp4 === "1");
                    $form.find("[name='enable_hls_fmp4']").prop("checked", defaultConfigs.enable_hls_fmp4 === "1");
                    
                    // æŒ‰éœ€æ¨¡å¼
                    $form.find("[name='rtsp_demand']").prop("checked", defaultConfigs.rtsp_demand === "1");
                    $form.find("[name='rtmp_demand']").prop("checked", defaultConfigs.rtmp_demand === "1");
                    $form.find("[name='hls_demand']").prop("checked", defaultConfigs.hls_demand === "1");
                    $form.find("[name='ts_demand']").prop("checked", defaultConfigs.ts_demand === "1");
                    $form.find("[name='fmp4_demand']").prop("checked", defaultConfigs.fmp4_demand === "1");
                    
                    // MP4å½•åˆ¶
                    $form.find("[name='enable_mp4']").prop("checked", defaultConfigs.enable_mp4 === "1");
                    $form.find("[name='mp4_as_player']").prop("checked", defaultConfigs.mp4_as_player === "1");
                    $form.find("[name='mp4_max_second']").val(defaultConfigs.mp4_max_second || 30);
                    
                    // å…¶ä»–é…ç½®
                    if (defaultConfigs.modify_stamp !== undefined) {
                      $form.find("[name='modify_stamp']").val(defaultConfigs.modify_stamp);
                    }
                    $form.find("[name='auto_close']").prop("checked", defaultConfigs.auto_close === "1");
                    
                    // æ¸²æŸ“ layui è¡¨å•æ§ä»¶ï¼ˆå¦‚ä¸‹æ‹‰æ¡†ã€å¼€å…³ï¼‰
                    form.render();

                    // é«˜çº§é…ç½®é»˜è®¤æ˜¾ç¤ºï¼Œæ— å±•å¼€æŠ˜å åŠŸèƒ½
                    let body = layero.find("#advanced_config_body");
                    let icon = layero.find("#advanced_config_icon");
                    let header = layero.find("#advanced_config_header");
                    body.show();
                    icon.removeClass("layui-icon-down").addClass("layui-icon-up");
                    // ä¿®æ”¹æ ·å¼ï¼Œä½¿å…¶çœ‹èµ·æ¥ä¸å¯ç‚¹å‡»
                    header.css({"cursor": "default", "pointer-events": "none"});

                    // è¡¨å•æäº¤
                    layero.find("#btn_submit").on("click", function (e) {
                      e.preventDefault(); // é˜»æ­¢é»˜è®¤æäº¤ï¼ˆé˜²æ­¢é¡µé¢åˆ·æ–°ï¼‰

                      // è·å–è¡¨å•
                      let $form = layero.find("#ID_active_pull_form");

                      // å¿…å¡«é¡¹éªŒè¯
                      let isValid = true;
                      $form.find("input[required]").each(function () {
                        let val = $(this).val();
                        if (!val || val.trim() === "") {
                          let placeholder = $(this).attr("placeholder") || "è¯¥å­—æ®µ";

                          layer.msg("âš ï¸ è¯·å¡«å†™ï¼š" + placeholder, {
                            time: 1500,
                            offset: "t",
                            shift: 1,
                          });

                          $(this).focus();
                          isValid = false;
                          return false; // è·³å‡º each å¾ªç¯
                        }
                      });
                      if (!isValid) return false;

                      let formData = {};
                      $form.find("input, select").each(function () {
                        let $el = $(this);
                        let name = $el.attr("name");
                        if (!name) return true;

                        let value;
                        if ($el.is(":checkbox")) {
                          value = $el.is(":checked") ? "1" : "0";
                        } else {
                          value = $el.val();
                        }

                        formData[name] = value;
                      });

                      // æ„å»ºè¯·æ±‚URL
                      let urlParams = new URLSearchParams();
                      for (let key in formData) {
                        urlParams.append(key, formData[key]);
                      }

                      $.ajax({
                        url: `/api/stream/pull-proxy?${urlParams.toString()}`,
                        type: "POST",
                        timeout: 5000,
                        success: function (res) {
                          if (res.code === 0) {
                            layer.msg("âœ… æ·»åŠ æˆåŠŸ", {
                              time: 1500,
                              offset: "t",
                              shift: 1,
                            });
                            setTimeout(() => {
                              layer.close(index);
                            }, 300);
                          } else {
                            layer.msg("âš ï¸ " + res.msg, {
                              time: 1500,
                              offset: "t",
                              shift: 1,
                            });
                          }
                        },
                      });
                    });

                    // ç»‘å®šå–æ¶ˆæŒ‰é’®äº‹ä»¶
                    layero.find("#btn_cancel").on("click", function () {
                      layer.close(index);
                    });
                  },
                  end: function () {
                    // ç›‘å¬å¼¹çª—å…³é—­å°±åˆ·æ–°è¡¨æ ¼
                    setTimeout(() => {
                      renderTable();
                    }, 300);
                  },
                });
              } else {
                layer.msg("âš ï¸ è·å–é»˜è®¤é…ç½®å¤±è´¥ï¼š" + res.msg, {
                  time: 1500,
                  offset: "t",
                  shift: 1,
                });
              }
            },
            error: function () {
              layer.msg("âŒ ç½‘ç»œè¯·æ±‚å¤±è´¥", {
                time: 1500,
                offset: "t",
                shift: 1,
              });
            }
          });
        });

        // ç›‘å¬onvifæ¥å…¥æŒ‰é’®
        $("#ID_pull_onvif_btn").on("click", function () {
          layer.open({
            type: 1,
            title: "ONVIFæ¥å…¥",
            area: ["700px", "100%"],
            content: $("#ID_tpl_pull_onvif").html(),
            shadeClose: true,
            btn: null,
            success: function (layero, index) {
              let $layer = $(layero);

              // è·å–è®¾å¤‡ä¿¡æ¯æŒ‰é’®
              $layer.find("#btn_fetch_device").on("click", function () {
                let ip = $layer.find('[name="onvif-cameraip"]').val().trim();
                let port = $layer.find('[name="onvif-port"]').val().trim();
                let user = $layer.find('[name="onvif-username"]').val().trim();
                let pwd = $layer.find('[name="onvif-password"]').val().trim();

                if (!ip || !user || !pwd) {
                  layer.msg("âš ï¸ è¯·å¡«å†™å®Œæ•´çš„æ‘„åƒæœºä¿¡æ¯", {
                    time: 1500,
                    offset: "t",
                    shift: 1,
                  });
                  return;
                }

                let loading = layer.load(2, { shade: [0.1, "#fff"] });

                $.ajax({
                  url: `/api/onvif/profiles?cameraip=${ip}&port=${port}&username=${user}&password=${pwd}`, // æ›¿æ¢ä¸ºä½ çš„å®é™…æ¥å£
                  method: "GET",
                  success: function (res) {
                    layer.close(loading);

                    if (res.code === 0 && res.data?.profiles?.length > 0) {
                      let dev = res.data.device_info;
                      $layer
                        .find("#device_manufacturer")
                        .text(dev.manufacturer || "-");
                      $layer.find("#device_model").text(dev.model || "-");
                      $layer
                        .find("#device_firmware")
                        .text(dev.firmware_version || "-");
                      $layer
                        .find("#device_serial")
                        .text(dev.serial_number || "-");

                      // æ¸…ç©ºå¹¶å¡«å……ç æµé€‰é¡¹
                      let $select = $layer.find("#profile_select");
                      $select
                        .empty()
                        .append('<option value="">è¯·é€‰æ‹©ç æµ</option>');
                      res.data.profiles.forEach(function (p) {
                        let label = `${p.name} (${p.video.width}x${p.video.height}@${p.video.framerate}fps, ${p.video.encoding})`;
                        $select.append(
                          `<option value="${p.token}" data-url="${p.rtsp_url}">${label}</option>`
                        );
                      });

                      $layer.find("#device_info_area").show();
                      layui.form.render("select"); // é‡æ–°æ¸²æŸ“ä¸‹æ‹‰æ¡†
                    } else {
                      layer.msg("âŒ è·å–è®¾å¤‡ä¿¡æ¯å¤±è´¥ " + res.msg, {
                        time: 1500,
                        offset: "t",
                        shift: 1,
                      });
                    }
                  },
                  error: function () {
                    layer.msg("âŒ ç½‘ç»œè¯·æ±‚å¤±è´¥ï¼Œè¯·æ£€æŸ¥æ¥å£", {
                      time: 1500,
                      offset: "t",
                      shift: 1,
                    });
                  },
                });
              });

              // ç›‘å¬ç æµé€‰æ‹©
              layui.form.on("select(profile_select)", function (data) {
                let $layer = $(data.elem)
                  .closest(".layui-layer-content")
                  .parent();
                let selectedOption = $(data.elem).find("option:selected");
                let url = selectedOption.data("url");

                if (url) {
                  console.log("é€‰æ‹©äº† ", url);

                  // æ˜¾ç¤ºåç»­è¡¨å•é¡¹
                  $layer.find("#app_item").show();
                  $layer.find("#stream_item").show();
                  $layer.find("#audio_item").show();
                  $layer.find("#submit_btns").show();

                  // å¯é€‰ï¼šè‡ªåŠ¨å¡«å……æµIDï¼ˆä¾‹å¦‚ä»RTSPä¸­æå–ï¼‰
                  // æ­¤å¤„ç•™ç©ºï¼Œç”±ç”¨æˆ·æ‰‹åŠ¨è¾“å…¥
                } else {
                  console.log("æœªé€‰æ‹©");

                  $layer.find("#app_item").hide();
                  $layer.find("#stream_item").hide();
                  $layer.find("#audio_item").hide();
                  $layer.find("#submit_btns").hide();
                }
              });

              // å–æ¶ˆæŒ‰é’®
              $layer.find("#btn_cancel").on("click", function () {
                layer.close(index);
              });

              // è¡¨å•æäº¤
              $layer.find("#ID_active_pull_form").on("submit", function (e) {
                e.preventDefault();

                // æ”¶é›†æ‰€æœ‰æ•°æ®
                let formData = {};
                $(this)
                  .serializeArray()
                  .forEach(function (item) {
                    formData[item.name] = item.value;
                  });

                // æ·»åŠ  url
                let selectedToken = formData["selected_profile_token"];
                if (selectedToken) {
                  let url = $layer
                    .find(`#profile_select option[value="${selectedToken}"]`)
                    .data("url");
                  formData.url = url;
                }

                // è¿™é‡Œå¯ä»¥æäº¤åˆ°ä½ çš„æ‹‰æµæ¥å£
                // console.log("æäº¤æ•°æ®ï¼š", formData);
                $.ajax({
                  url: `/api/stream/pull-proxy?app=${formData.app}&stream=${formData.stream}&url=${formData.url}&audio_type=${formData.audio_type}`,
                  type: "POST",
                  timeout: 5000,
                  success: function (res) {
                    if (res.code === 0) {
                      layer.msg("âœ… æ·»åŠ æˆåŠŸ", {
                        time: 1500,
                        offset: "t",
                        shift: 1,
                      });
                      setTimeout(() => {
                        layer.close(index);
                      }, 300);
                    } else {
                      layer.msg("âš ï¸ " + res.msg, {
                        time: 1500,
                        offset: "t",
                        shift: 1,
                      });
                    }
                  },
                });
              });
            },
            end: function () {
              // ç›‘å¬å¼¹çª—å…³é—­å°±åˆ·æ–°è¡¨æ ¼
              setTimeout(() => {
                renderTable();
              }, 300);
            },
          });
        });

        // ç›‘å¬è¡¨æ ¼æœç´¢æŒ‰é’®
        $("#ID_table_btnSearch").on("click", function () {
          renderTable();
        });

        // ç›‘å¬è¡¨æ ¼é‡ç½®æŒ‰é’®
        $("#ID_table_btnReset").on("click", function () {
          $("#ID_searchApp").val("");
          $("#ID_searchStream").val("");
          renderTable();
        });

        // åˆå§‹åŒ–
        $("#ID_searchApp").val("");
        $("#ID_searchStream").val("");
        renderTable();
      });
    </script>
  </body>
</html>
