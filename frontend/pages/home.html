<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1, maximum-scale=1"
    />
  </head>

  <body>
    <div style="padding: 16px 16px 0 16px">
      <div class="layui-card">
        <!-- <div class="layui-card-header">ZLM Perf</div> -->
        <div class="layui-card-body" style="display: flex; overflow-x: auto">
          <div id="ID_chart_statistic" style="flex: 1; height: 400px"></div>
          <div
            id="ID_chart_workthreadsload"
            style="flex: 1; height: 400px"
          ></div>
          <div id="ID_chart_threadsload" style="flex: 1; height: 400px"></div>
        </div>
      </div>
    </div>

    <div style="padding: 16px 16px 0 16px">
      <div class="layui-card">
        <!-- <div class="layui-card-header">Host Perf</div> -->
        <div class="layui-card-body" style="display: flex">
          <div id="ID_chart_cpu" style="flex: 1; height: 400px"></div>
          <div id="ID_chart_memory" style="flex: 1; height: 400px"></div>
          <div id="ID_chart_disk" style="flex: 1; height: 400px"></div>
          <div id="ID_chart_network" style="flex: 1; height: 400px"></div>
        </div>
      </div>
    </div>

    <script>
      layui.use(["table", "layer", "jquery"], function () {
        let table = layui.table;
        let layer = layui.layer;
        let $ = layui.jquery;

        let statisticTimer = null;
        let workThreadsLoadTimer = null;
        let threadsLoadTimer = null;
        let hostSatesTimer = null;

        // 存储最近10次系统数据
        if (window.historyData == undefined) {
          window.historyData = [];
        }

        window.isPolling = true; // 进入页面启动轮询

        let chartStatistic = echarts.init(document.getElementById("ID_chart_statistic"));
        let chartWorkThreadsLoad = echarts.init(document.getElementById("ID_chart_workthreadsload"));
        let chartThreadsLoad = echarts.init(document.getElementById("ID_chart_threadsload"));
        let chartCpu = echarts.init(document.getElementById("ID_chart_cpu"));
        let chartMemory = echarts.init(document.getElementById("ID_chart_memory"));
        let chartDisk = echarts.init(document.getElementById("ID_chart_disk"));
        let chartNetwork = echarts.init(document.getElementById("ID_chart_network"));

        // 防抖函数
        function debounce(func, wait) {
          let timeout;
          return function executedFunction(...args) {
            const later = () => {
              clearTimeout(timeout);
              func(...args);
            };
            clearTimeout(timeout);
            timeout = setTimeout(later, wait);
          };
        }

        // 优化：减少轮询频率，从3秒改为5秒
        const POLLING_INTERVAL = 5000;

        function renderStatisticChart() {
          if (!window.isPolling) return;
          
          $.ajax({
            url: "/api/perf/statistic",
            type: "GET",
            dataType: "json",
            timeout: 5000,
            success: function (res) {
              if (res.code === 0) {
                chartStatistic.setOption({
                  title: {
                    text: "Statistic",
                    left: "center",
                    textStyle: { fontSize: 14 },
                  },
                  tooltip: {},
                  xAxis: {
                    type: "category",
                    data: Object.keys(res.data),
                    axisLabel: { rotate: 45, fontSize: 10 },
                  },
                  yAxis: { type: "value" },
                  series: [
                    {
                      type: "bar",
                      data: Object.values(res.data),
                      itemStyle: { color: "#009688" },
                    },
                  ],
                });
              }
            },
            complete: function () {
              if (window.isPolling) {
                statisticTimer = setTimeout(renderStatisticChart, POLLING_INTERVAL);
              }
            },
          });
        }

        function renderWorkThreadsLoadChart() {
          if (!window.isPolling) return;
          
          $.ajax({
            url: "/api/perf/work-threads-load",
            type: "GET",
            dataType: "json",
            timeout: 5000,
            success: function (res) {
              if (res.code === 0) {
                let delays = [];
                let loads = [];
                let names = [];

                res.data.forEach(function (item) {
                  names.push(item.name.replace("work poller ", "work "));
                  delays.push(item.delay);
                  loads.push(item.load);
                });

                chartWorkThreadsLoad.setOption({
                  title: {
                    text: "WorkThreadsLoad",
                    left: "center",
                    textStyle: { fontSize: 14 },
                  },
                  tooltip: {
                    trigger: "axis",
                  },
                  legend: {
                    data: ["延迟", "负载"],
                    bottom: "5%",
                    itemWidth: 12,
                    itemHeight: 8,
                  },
                  xAxis: [
                    {
                      type: "category",
                      data: names,
                      axisLabel: { rotate: 45, fontSize: 10 },
                    },
                  ],
                  yAxis: [
                    { type: "value", name: "延迟ms", position: "left" },
                    { type: "value", name: "负载%", position: "right" },
                  ],
                  series: [
                    {
                      name: "延迟",
                      type: "line",
                      data: delays,
                      yAxisIndex: 0,
                      itemStyle: { color: "#5B8FF9" },
                    },
                    {
                      name: "负载",
                      type: "bar",
                      data: loads,
                      yAxisIndex: 1,
                      itemStyle: { color: "#D7504B" },
                    },
                  ],
                });
              }
            },
            complete: function () {
              if (window.isPolling) {
                workThreadsLoadTimer = setTimeout(renderWorkThreadsLoadChart, POLLING_INTERVAL);
              }
            },
          });
        }

        function renderThreadsLoadChart() {
          if (!window.isPolling) return;
          
          $.ajax({
            url: "/api/perf/threads-load",
            type: "GET",
            dataType: "json",
            timeout: 5000,
            success: function (res) {
              if (res.code === 0) {
                let delays = [];
                let loads = [];
                let names = [];

                res.data.forEach(function (item) {
                  names.push(item.name.replace("event poller ", "event "));
                  delays.push(item.delay);
                  loads.push(item.load);
                });

                chartThreadsLoad.setOption({
                  title: {
                    text: "ThreadsLoad",
                    left: "center",
                    textStyle: { fontSize: 14 },
                  },
                  tooltip: { trigger: "axis" },
                  legend: {
                    data: ["延迟", "负载"],
                    bottom: "5%",
                    itemWidth: 12,
                    itemHeight: 8,
                  },
                  xAxis: [
                    {
                      type: "category",
                      data: names,
                      axisLabel: { rotate: 45, fontSize: 10 },
                    },
                  ],
                  yAxis: [
                    { type: "value", name: "延迟ms", position: "left" },
                    { type: "value", name: "负载%", position: "right" },
                  ],
                  series: [
                    {
                      name: "延迟",
                      type: "line",
                      data: delays,
                      yAxisIndex: 0,
                      itemStyle: { color: "#5B8FF9" },
                    },
                    {
                      name: "负载",
                      type: "bar",
                      data: loads,
                      yAxisIndex: 1,
                      itemStyle: { color: "#D7504B" },
                    },
                  ],
                });
              }
            },
            complete: function () {
              if (window.isPolling) {
                threadsLoadTimer = setTimeout(renderThreadsLoadChart, POLLING_INTERVAL);
              }
            },
          });
        }

        function renderHostStatsChart() {
          if (!window.isPolling) return;
          
          $.ajax({
            url: "/api/perf/host-stats",
            type: "GET",
            dataType: "json",
            timeout: 5000,
            success: function (res) {
              if (res.code === 0) {
                const currentData = res.data;

                // 把当前数据加入前端维护的历史
                window.historyData.push(currentData);

                // 只保留最近 10 条，增加数据点以获得更平滑的图表
                if (window.historyData.length > 10) {
                  window.historyData.shift(); // 删除最老的一条
                }

                const dataList = window.historyData;

                // ----------------------------
                // 1. CPU 使用
                // ----------------------------
                let times = dataList.map((d) => d.time);
                let cpuData = dataList.map((d) => d.cpu);

                chartCpu.setOption({
                  title: {
                    text: "CPU 使用",
                    left: "center",
                    textStyle: { fontSize: 14 },
                  },
                  tooltip: {
                    trigger: "axis",
                    formatter: "{b}: {c}%",
                  },
                  legend: {
                    data: ["CPU"],
                    bottom: "5%",
                    itemWidth: 12,
                    itemHeight: 8,
                  },
                  xAxis: {
                    type: "category",
                    boundaryGap: false,
                    data: times,
                    axisLabel: { rotate: 45, fontSize: 10 },
                  },
                  yAxis: {
                    type: "value",
                    axisLabel: {
                      formatter: "{value}%",
                    },
                    min: 0,
                    max: 100,
                  },
                  series: [
                    {
                      name: "CPU",
                      type: "line",
                      data: cpuData,
                      smooth: true,
                      lineStyle: {
                        color: "#73c0de",
                        width: 2,
                      },
                      itemStyle: {
                        color: "#73c0de",
                      },
                      areaStyle: {
                        color: "rgba(115, 192, 222, 0.5)",
                      },
                    },
                  ],
                });

                // ----------------------------
                // 2. 内存使用
                // ----------------------------
                chartMemory.setOption({
                  title: {
                    text: "内存使用",
                    left: "center",
                    textStyle: { fontSize: 14 },
                  },
                  tooltip: {
                    trigger: "axis",
                    formatter: "{b}: {c} GB",
                  },
                  legend: {
                    data: ["已用内存"],
                    bottom: "5%",
                    itemWidth: 12,
                    itemHeight: 8,
                  },
                  xAxis: {
                    type: "category",
                    boundaryGap: false,
                    data: dataList.map((item) => item.time),
                    axisLabel: {
                      rotate: 45,
                      fontSize: 10,
                    },
                  },
                  yAxis: {
                    type: "value",
                    axisLabel: {
                      formatter: "{value} GB",
                    },
                    max: parseFloat(currentData.memory.total),
                  },
                  series: [
                    {
                      name: "已用内存",
                      type: "line",
                      data: dataList.map((item) => parseFloat(item.memory.used)),
                      lineStyle: {
                        color: "#5470c6",
                      },
                      itemStyle: {
                        color: "#5470c6",
                      },
                      areaStyle: {},
                    },
                  ],
                });

                // ----------------------------
                // 3. 磁盘使用
                // ----------------------------
                let diskUsed = parseFloat(currentData.disk.used);
                let diskTotal = parseFloat(currentData.disk.total);
                let diskFree = diskTotal - diskUsed;

                let diskUsedStr = diskUsed.toFixed(1);
                let diskFreeStr = diskFree.toFixed(1);

                chartDisk.setOption({
                  title: {
                    text: "磁盘使用",
                    left: "center",
                    textStyle: { fontSize: 14 },
                  },
                  tooltip: {
                    formatter: "{b}: {c} GB",
                  },
                  legend: {
                    data: ["已用", "剩余"],
                    bottom: "5%",
                    itemWidth: 12,
                    itemHeight: 8,
                  },
                  grid: {
                    left: "8%",
                    right: "8%",
                    top: "15%",
                    bottom: "20%",
                  },
                  xAxis: {
                    type: "value",
                    max: diskTotal,
                    axisLabel: {
                      formatter: "{value} GB",
                      fontSize: 10,
                    },
                    splitLine: { show: false },
                    axisTick: { show: true },
                  },
                  yAxis: {
                    type: "category",
                    data: ["磁盘"],
                    axisLabel: { show: false },
                  },
                  series: [
                    {
                      name: "已用",
                      type: "bar",
                      stack: "disk",
                      label: {
                        show: true,
                        position: "inside",
                        formatter: diskUsedStr + " GB",
                        color: "#fff",
                      },
                      itemStyle: {
                        color: "#91cc75",
                      },
                      data: [diskUsed],
                    },
                    {
                      name: "剩余",
                      type: "bar",
                      stack: "disk",
                      label: {
                        show: true,
                        position: "inside",
                        formatter: diskFreeStr + " GB",
                      },
                      itemStyle: {
                        color: "#e0e0e0",
                      },
                      data: [diskFree],
                    },
                  ],
                  tooltip: {
                    formatter: function (params) {
                      const unit = " GB";
                      return params.seriesName + ": " + parseFloat(params.value).toFixed(1) + unit;
                    },
                  },
                });

                // ----------------------------
                // 4. 带宽使用
                // ----------------------------
                let netRecvMbps = [];
                let netSentMbps = [];
                let networkTimes = [];

                function parseTimeToMs(timeStr) {
                  const [h, m, s] = timeStr.split(":").map(Number);
                  return (h * 3600 + m * 60 + s) * 1000;
                }

                for (let i = 1; i < dataList.length; i++) {
                  const prevTimeMs = parseTimeToMs(times[i - 1]);
                  const currTimeMs = parseTimeToMs(times[i]);
                  const timeDiffSec = (currTimeMs - prevTimeMs) / 1000;

                  if (timeDiffSec >= 4.5 && timeDiffSec <= 5.5) {
                    const bytesRecvDiff = dataList[i].network.recv - dataList[i - 1].network.recv;
                    const bytesSentDiff = dataList[i].network.sent - dataList[i - 1].network.sent;

                    if (bytesRecvDiff < 0 || bytesSentDiff < 0) continue;

                    const mbpsRecv = ((bytesRecvDiff * 8) / 1000000 / timeDiffSec).toFixed(2);
                    const mbpsSent = ((bytesSentDiff * 8) / 1000000 / timeDiffSec).toFixed(2);

                    netRecvMbps.push(parseFloat(mbpsRecv));
                    netSentMbps.push(parseFloat(mbpsSent));
                    networkTimes.push(times[i]);
                  }
                }

                chartNetwork.setOption({
                  title: {
                    text: "带宽使用",
                    left: "center",
                    textStyle: { fontSize: 14 },
                  },
                  tooltip: {
                    trigger: "axis",
                    formatter: function(params) {
                      if (!params || !params[0]) return '';
                      let result = params[0].name + '<br/>';
                      params.forEach(function(p) {
                        result += p.seriesName + ': ' + p.value + ' Mbps<br/>';
                      });
                      return result;
                    },
                  },
                  legend: {
                    data: ["接收", "发送"],
                    bottom: "5%",
                    itemWidth: 12,
                    itemHeight: 8,
                  },
                  xAxis: {
                    type: "category",
                    data: networkTimes,
                    axisLabel: {
                      rotate: 45,
                      fontSize: 10,
                    },
                  },
                  yAxis: {
                    type: "value",
                    min: 0,
                    axisLabel: {
                      formatter: "{value} Mbps",
                    },
                  },
                  series: [
                    {
                      name: "接收",
                      type: "line",
                      data: netRecvMbps,
                      smooth: true,
                      lineStyle: {
                        width: 2,
                        color: "#91cc75",
                      },
                      itemStyle: {
                        color: "#91cc75",
                      },
                      areaStyle: {
                        color: {
                          type: "linear",
                          x: 0,
                          y: 0,
                          x2: 0,
                          y2: 1,
                          colorStops: [
                            {
                              offset: 0,
                              color: "rgba(145, 204, 117, 0.5)",
                            },
                            {
                              offset: 1,
                              color: "rgba(145, 204, 117, 0.1)",
                            },
                          ],
                        },
                      },
                    },
                    {
                      name: "发送",
                      type: "line",
                      data: netSentMbps,
                      smooth: true,
                      lineStyle: {
                        width: 2,
                        color: "#fac858",
                      },
                      itemStyle: {
                        color: "#fac858",
                      },
                      areaStyle: {
                        color: {
                          type: "linear",
                          x: 0,
                          y: 0,
                          x2: 0,
                          y2: 1,
                          colorStops: [
                            {
                              offset: 0,
                              color: "rgba(250, 200, 88, 0.5)",
                            },
                            {
                              offset: 1,
                              color: "rgba(250, 200, 88, 0.1)",
                            },
                          ],
                        },
                      },
                    },
                  ],
                });
              }
            },
            complete: function () {
              if (window.isPolling) {
                hostSatesTimer = setTimeout(renderHostStatsChart, POLLING_INTERVAL);
              }
            },
          });
        }

        window.clearnTimer = function () {
          window.isPolling = false;
          
          if (statisticTimer !== null) {
            clearTimeout(statisticTimer);
            statisticTimer = null;
          }
          if (threadsLoadTimer !== null) {
            clearTimeout(threadsLoadTimer);
            threadsLoadTimer = null;
          }
          if (workThreadsLoadTimer !== null) {
            clearTimeout(workThreadsLoadTimer);
            workThreadsLoadTimer = null;
          }
          if (hostSatesTimer !== null) {
            clearTimeout(hostSatesTimer);
            hostSatesTimer = null;
          }
          
          // 销毁图表实例，释放内存
          if (chartStatistic) chartStatistic.dispose();
          if (chartWorkThreadsLoad) chartWorkThreadsLoad.dispose();
          if (chartThreadsLoad) chartThreadsLoad.dispose();
          if (chartCpu) chartCpu.dispose();
          if (chartMemory) chartMemory.dispose();
          if (chartDisk) chartDisk.dispose();
          if (chartNetwork) chartNetwork.dispose();
          
          // 清空历史数据
          window.historyData = [];
        };

        // 窗口大小变化时，重新调整图表大小
        window.addEventListener('resize', debounce(function() {
          if (chartStatistic) chartStatistic.resize();
          if (chartWorkThreadsLoad) chartWorkThreadsLoad.resize();
          if (chartThreadsLoad) chartThreadsLoad.resize();
          if (chartCpu) chartCpu.resize();
          if (chartMemory) chartMemory.resize();
          if (chartDisk) chartDisk.resize();
          if (chartNetwork) chartNetwork.resize();
        }, 250));

        renderStatisticChart();
        renderThreadsLoadChart();
        renderWorkThreadsLoadChart();
        renderHostStatsChart();
      });
    </script>
  </body>
</html>